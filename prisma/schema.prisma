// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  passwordHash  String?   @map("password_hash") // For Rust backend compatibility
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  resumes         Resume[]
  customTemplates CustomTemplate[]
  savedJobs       SavedJob[]
  jobApplications JobApplication[]
  jobAlerts       JobAlert[]

  @@map("users")
}

// Resume model
model Resume {
  id        String   @id @default(cuid())
  userId    String
  name      String
  slug      String   @unique
  status    String   @default("draft") // draft, published, archived
  version   Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  personalInfo  PersonalInfo?
  experiences   WorkExperience[]
  education     Education[]
  skills        Skill[]
  customization ResumeCustomization?
  snapshots     ResumeSnapshot[]
  shareLinks    ShareLink[]
  analytics     ResumeAnalytics[]
  applications  JobApplication[]

  @@index([userId])
  @@index([slug])
  @@map("resumes")
}

// Personal information
model PersonalInfo {
  id        String   @id @default(cuid())
  resumeId  String   @unique
  firstName String
  lastName  String
  email     String
  phone     String
  location  String?
  linkedin  String?
  website   String?
  summary   String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  resume    Resume   @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@map("personal_info")
}

// Work experience
model WorkExperience {
  id           String   @id @default(cuid())
  resumeId     String
  company      String
  position     String
  location     String?
  startDate    String
  endDate      String?
  isCurrent    Boolean  @default(false)
  achievements String[] // Array of achievement strings
  order        Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  resume       Resume   @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@index([resumeId])
  @@map("work_experiences")
}

// Education
model Education {
  id        String   @id @default(cuid())
  resumeId  String
  school    String
  degree    String
  field     String?
  location  String?
  startDate String
  endDate   String
  gpa       String?
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  resume    Resume   @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@index([resumeId])
  @@map("education")
}

// Skills
model Skill {
  id        String   @id @default(cuid())
  resumeId  String
  name      String
  category  String   // technical, soft, language, tool
  level     String?  // beginner, intermediate, advanced, expert
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  resume    Resume   @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@index([resumeId])
  @@map("skills")
}

// Resume customization (template, colors, fonts)
model ResumeCustomization {
  id           String   @id @default(cuid())
  resumeId     String   @unique
  templateId   String   @default("modern")
  primaryColor String   @default("#E9684B")
  font         String   @default("inter")
  sectionOrder String[] @default(["experience", "education", "skills"])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  resume       Resume   @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@map("resume_customizations")
}

// Resume snapshots for versioning
model ResumeSnapshot {
  id         String   @id @default(cuid())
  resumeId   String
  data       String   @db.Text // JSON serialized resume data
  changeType String   // auto_save, manual_save, export
  createdAt  DateTime @default(now())

  resume     Resume   @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@index([resumeId])
  @@index([createdAt])
  @@map("resume_snapshots")
}

// Share links for public resume sharing
model ShareLink {
  id            String    @id @default(cuid())
  resumeId      String
  token         String    @unique // Public share token
  password      String?   // Optional password hash
  expiresAt     DateTime? // Optional expiration
  viewCount     Int       @default(0)
  maxViews      Int?      // Optional max view limit
  allowComments Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  resume        Resume    @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@index([resumeId])
  @@index([token])
  @@map("share_links")
}

// Resume analytics for tracking events
model ResumeAnalytics {
  id         String   @id @default(cuid())
  resumeId   String
  eventType  String   // view, export, share, edit, restore
  metadata   String?  @db.Text // JSON for additional event data
  timestamp  DateTime @default(now())

  resume     Resume   @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@index([resumeId])
  @@index([eventType])
  @@index([timestamp])
  @@map("resume_analytics")
}

// Custom resume templates created by users
model CustomTemplate {
  id        String   @id @default(cuid())
  userId    String
  name      String
  config    String   @db.Text // JSON configuration
  isPublic  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isPublic])
  @@map("custom_templates")
}

// ============================================
// JOBS FEATURE MODELS
// ============================================

// Cached job from external APIs
model Job {
  id              String   @id @default(cuid())
  externalId      String   // ID from the source API
  source          String   // remotive, remoteok, arbeitnow, himalayas, themuse, jobicy, usajobs

  // Core job info
  title           String
  company         String
  companyLogo     String?
  companyUrl      String?
  location        String?
  locationType    String   // remote, onsite, hybrid

  // Job details
  description     String   @db.Text
  descriptionHtml String?  @db.Text
  requirements    String?  @db.Text
  benefits        String?  @db.Text

  // Categorization
  category        String?  // engineering, design, marketing, sales, etc.
  tags            String[] // Array of job tags/skills
  experienceLevel String?  // entry, mid, senior, executive
  employmentType  String?  // full-time, part-time, contract, internship

  // Compensation
  salaryMin       Int?
  salaryMax       Int?
  salaryCurrency  String?
  salaryPeriod    String?  // yearly, monthly, hourly

  // Application
  applyUrl        String
  applicationEmail String?

  // Metadata
  publishedAt     DateTime?
  expiresAt       DateTime?
  fetchedAt       DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Sync management
  lastSyncedAt    DateTime @default(now())
  syncStatus      String   @default("active") // active, stale, expired
  isActive        Boolean  @default(true)
  viewCount       Int      @default(0)

  // Full-text search (computed by PostgreSQL trigger)
  searchVector    String?  @db.Text

  // Relations
  savedBy         SavedJob[]
  applications    JobApplication[]

  @@unique([source, externalId])
  @@index([source])
  @@index([category])
  @@index([locationType])
  @@index([publishedAt])
  @@index([title])
  @@index([company])
  @@index([isActive, publishedAt(sort: Desc)])
  @@index([company, title])
  @@index([lastSyncedAt])
  @@index([syncStatus])

  // NEW INDEXES FOR 100k+ SCALE:

  // Salary range queries
  @@index([salaryMin, salaryMax, salaryCurrency])

  // Common filter combinations
  @@index([isActive, category, locationType])
  @@index([isActive, experienceLevel, publishedAt(sort: Desc)])
  @@index([isActive, employmentType, publishedAt(sort: Desc)])

  @@map("jobs")
}

// Sync log for tracking background job synchronization
model SyncLog {
  id            String   @id @default(cuid())
  syncType      String   // daily, hourly, manual
  status        String   // pending, running, completed, failed

  // Progress tracking
  sourcesTotal      Int      @default(0)
  sourcesCompleted  Int      @default(0)
  sourcesSkipped    Int      @default(0)

  // Results
  jobsCreated   Int      @default(0)
  jobsUpdated   Int      @default(0)
  jobsStaled    Int      @default(0)
  jobsDeleted   Int      @default(0)

  // Error tracking
  errors        String?  @db.Text // JSON array of errors

  // Timing
  startedAt     DateTime @default(now())
  completedAt   DateTime?
  duration      Int?     // Duration in milliseconds

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([syncType])
  @@index([status])
  @@index([startedAt])
  @@map("sync_logs")
}

// User's saved/bookmarked jobs
model SavedJob {
  id        String   @id @default(cuid())
  userId    String
  jobId     String
  notes     String?  @db.Text
  priority  Int      @default(0) // 0=normal, 1=high, 2=very high
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([userId, jobId])
  @@index([userId])
  @@index([jobId])
  @@map("saved_jobs")
}

// Job applications tracking
model JobApplication {
  id              String   @id @default(cuid())
  userId          String
  jobId           String
  resumeId        String?

  // Application status
  status          String   @default("applied") // applied, screening, interviewing, offer, rejected, withdrawn, accepted

  // Application details
  coverLetter     String?  @db.Text
  appliedAt       DateTime @default(now())
  appliedVia      String   @default("direct") // direct, linkedin, email, referral

  // Interview tracking
  interviewRounds Int      @default(0)
  nextStepDate    DateTime?
  nextStepNotes   String?

  // Offer details
  offeredSalary   Int?
  offeredCurrency String?
  offerDeadline   DateTime?

  // Notes and timeline
  notes           String?  @db.Text
  timeline        String?  @db.Text // JSON array of status changes with timestamps

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  job             Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  resume          Resume?  @relation(fields: [resumeId], references: [id], onDelete: SetNull)

  @@unique([userId, jobId])
  @@index([userId])
  @@index([jobId])
  @@index([status])
  @@index([appliedAt])
  @@map("job_applications")
}

// Job search alerts
model JobAlert {
  id          String   @id @default(cuid())
  userId      String
  name        String

  // Search criteria
  keywords    String?
  locations   String[] // Array of locations
  categories  String[] // Array of categories
  locationType String? // remote, onsite, hybrid
  experienceLevel String?
  employmentType String?
  salaryMin   Int?

  // Alert settings
  frequency   String   @default("daily") // instant, daily, weekly
  isActive    Boolean  @default(true)
  lastSentAt  DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
  @@map("job_alerts")
}
